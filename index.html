<!DOCTYPE html>
<html>
<head>
    <title>Perfected AR Cinema</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; background: rgba(0,0,0,0.8);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; font-family: sans-serif; text-align: center;
        }
        .ui-box { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; width: 80%; max-width: 300px; }
        button { 
            width: 100%; padding: 15px; margin: 10px 0; border: none; 
            border-radius: 10px; font-weight: bold; cursor: pointer;
            background: #007bff; color: white; font-size: 16px;
        }
        #my-id { color: #00ff00; font-family: monospace; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="overlay" class="overlay">
        <div class="ui-box">
            <h2>AR Cinema</h2>
            <div id="my-id">Generating ID...</div>
            <input type="text" id="target-id" placeholder="Paste ID from Other Phone" 
                   style="width:90%; padding:10px; margin-bottom:10px; border-radius:5px; border:none;">
            <button onclick="initProjector()">Phone A: Share Screen</button>
            <button style="background: #28a745;" onclick="initViewer()">Phone B: Start AR View</button>
        </div>
        <p style="font-size: 12px; margin-top: 20px;">Must use HTTPS to see camera.</p>
    </div>

    <a-scene embedded arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;" renderer="logarithmicDepthBuffer: true;">
        <a-assets>
            <video id="shared-video" autoplay playsinline crossorigin="anonymous" muted></video>
        </a-assets>

        <a-video id="ar-screen" src="#shared-video" 
                 width="4" height="2.25" 
                 position="0 1.6 -3"
                 rotation="0 0 0"
                 material="shader: flat; side: double;">
        </a-video>

        <a-entity camera look-controls></a-entity>
    </a-scene>

    <script>
        const peer = new Peer();
        const video = document.getElementById('shared-video');
        const overlay = document.getElementById('overlay');

        peer.on('open', (id) => {
            document.getElementById('my-id').innerText = "YOUR ID: " + id;
        });

        // Receiving logic (Phone B)
        function initViewer() {
            overlay.style.display = 'none'; // Hide menu
            // Unlock audio/video
            video.play(); 
            peer.on('call', (call) => {
                call.answer();
                call.on('stream', (stream) => {
                    video.srcObject = stream;
                    video.muted = false; // Unmute now that user has interacted
                    video.play();
                });
            });
        }

        // Sharing logic (Phone A)
        async function initProjector() {
            const tid = document.getElementById('target-id').value;
            if(!tid) return alert("Enter ID first");
            
            try {
                // Must be in "Desktop Site" mode on Android
                const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                peer.call(tid, stream);
                overlay.innerHTML = "<h1>Streaming...</h1><p>Switch to YouTube now!</p>";
            } catch (e) {
                alert("Error: " + e + "\n\nTry 'Desktop Site' mode!");
            }
        }
    </script>
</body>
</html>

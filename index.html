<!DOCTYPE html>
<html>
<head>
    <title>Visible AR Cinema</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        .ui { position: absolute; z-index: 1000; top: 10px; left: 10px; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; color: white; width: 260px; }
        button { padding: 12px; width: 100%; margin-top: 8px; cursor: pointer; border-radius: 8px; border: none; font-weight: bold; background: #007bff; color: white; }
        .log-box { position: absolute; bottom: 10px; left: 10px; width: 90%; background: rgba(0,0,0,0.5); color: #0f0; font-family: monospace; font-size: 10px; z-index: 1000; max-height: 80px; overflow-y: scroll; pointer-events: none; }
    </style>
</head>
<body>

    <div class="ui">
        <div id="status">ðŸ”µ Connecting...</div>
        <div id="my-id" style="font-family: monospace; color: #0f0;">ID: ...</div>
        <input type="text" id="target-id" placeholder="Partner ID" style="width:90%; padding:8px; margin:10px 0; border-radius: 4px;">
        <button onclick="startSharing()">SHARE SCREEN</button>
        <button onclick="recenterScreen()" style="background:#f39c12;">BRING SCREEN TO ME</button>
        <button onclick="manualPlay()" style="background:#28a745;">FORCE VIDEO START</button>
    </div>

    <div class="log-box" id="logs">LOGS:<br></div>

    <a-scene embedded arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;">
        <a-assets>
            <video id="shared-video" autoplay playsinline crossorigin="anonymous" muted></video>
        </a-assets>

        <a-entity id="screen-container" position="0 1.6 -3">
            <a-video id="ar-screen" src="#shared-video" width="4" height="2.25" material="shader: flat; side: double;">
                <a-entity geometry="primitive: plane; width: 4.2; height: 2.4" material="color: red; side: double" position="0 0 -0.01"></a-entity>
            </a-video>
        </a-entity>

        <a-entity id="main-cam" camera look-controls position="0 1.6 0"></a-entity>
    </a-scene>

    <script>
        const log = (m) => { document.getElementById('logs').innerHTML += "> " + m + "<br>"; };
        const peer = new Peer();
        const video = document.getElementById('shared-video');
        const screenContainer = document.getElementById('screen-container');
        const camera = document.getElementById('main-cam');

        peer.on('open', (id) => {
            document.getElementById('my-id').innerText = "ID: " + id;
            document.getElementById('status').innerText = "ðŸŸ¢ Online";
        });

        peer.on('call', (call) => {
            log("Incoming call...");
            call.answer();
            call.on('stream', (stream) => {
                log("STREAM RECEIVED");
                video.srcObject = stream;
                video.play().then(() => log("Video Playing!")).catch(e => log("Play Error: "+e));
            });
        });

        async function startSharing() {
            const tid = document.getElementById('target-id').value;
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                peer.call(tid, stream);
                log("Sharing started.");
            } catch (err) { alert("Use 'Desktop Site' mode!"); }
        }

        function recenterScreen() {
            log("Recentering...");
            // Get camera rotation
            const rotation = camera.getAttribute('rotation');
            const position = camera.getAttribute('position');
            
            // Move container in front of current camera view
            screenContainer.setAttribute('rotation', `0 ${rotation.y} 0`);
            log("Screen moved to your view.");
        }

        function manualPlay() {
            video.muted = false;
            video.play();
            log("Manual play triggered.");
        }

        // Texture Update Loop: Some Androids need this to show the video frame
        setInterval(() => {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const mesh = document.getElementById('ar-screen').getObject3D('mesh');
                if (mesh && mesh.material.map) mesh.material.map.needsUpdate = true;
            }
        }, 100);
    </script>
</body>
</html>

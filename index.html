<!DOCTYPE html>
<html>
<head>
    <title>Visual Fix AR Cinema</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        .ui-panel {
            position: absolute; z-index: 1000; top: 10px; left: 10px;
            background: rgba(0,0,0,0.85); padding: 15px; border-radius: 12px;
            color: white; width: 260px; border: 2px solid #007bff;
        }
        button { 
            width: 100%; padding: 12px; margin-top: 8px; border-radius: 8px;
            border: none; font-weight: bold; cursor: pointer; color: white;
        }
        #log-window {
            position: absolute; bottom: 10px; left: 10px; width: 90%;
            background: rgba(0,0,0,0.6); color: #0f0; font-family: monospace;
            font-size: 11px; padding: 5px; max-height: 80px; overflow-y: auto; z-index: 1000;
        }
    </style>
</head>
<body>

    <div class="ui-panel">
        <div id="status">ðŸ“¡ Status: Offline</div>
        <div id="id-display" style="color: #00ff00; margin: 5px 0;">ID: ...</div>
        <input type="text" id="target-id" placeholder="Paste ID here" style="width:90%; padding:8px; margin-bottom:5px;">
        <button onclick="startSharing()" style="background: #007bff;">1. SHARE SCREEN</button>
        <button onclick="fixView()" style="background: #f39c12;">2. FIX MY VIEW (TELEPORT)</button>
        <button onclick="forcePlay()" style="background: #28a745;">3. FORCE VIDEO TEXTURE</button>
    </div>

    <div id="log-window">SYSTEM LOGS:<br></div>

    <a-scene embedded 
             arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;" 
             renderer="antialias: true; logarithmicDepthBuffer: true; colorManagement: true; alpha: true;">
        
        <a-assets>
            <video id="shared-video" autoplay playsinline crossorigin="anonymous" muted></video>
        </a-assets>

        <a-box id="debug-cube" position="0 0.5 -2" scale="0.3 0.3 0.3" color="red" 
               animation="property: rotation; to: 0 360 0; loop: true; dur: 3000"></a-box>

        <a-entity id="screen-anchor" position="0 1.6 -4">
            <a-plane id="ar-plane" 
                     width="4" height="2.25" 
                     material="src: #shared-video; shader: flat; side: double; transparent: false; depthTest: false;">
                <a-entity geometry="primitive: plane; width: 4.2; height: 2.4" 
                          material="color: #00fbff; side: double; wireframe: true" 
                          position="0 0 -0.01"></a-entity>
            </a-plane>
        </a-entity>

        <a-entity id="rig" position="0 1.6 0">
            <a-camera id="main-cam" look-controls wasd-controls="acceleration: 20"></a-camera>
        </a-entity>
    </a-scene>

    <script>
        const logs = document.getElementById('log-window');
        const print = (m) => { logs.innerHTML += "> " + m + "<br>"; logs.scrollTop = logs.scrollHeight; };
        
        const peer = new Peer();
        const video = document.getElementById('shared-video');
        const screen = document.getElementById('ar-plane');
        const anchor = document.getElementById('screen-anchor');
        const camera = document.getElementById('main-cam');

        peer.on('open', (id) => {
            document.getElementById('id-display').innerText = "YOUR ID: " + id;
            document.getElementById('status').innerText = "ðŸ“¡ Status: Online";
            print("Server Connected.");
        });

        // Receiving logic
        peer.on('call', (call) => {
            print("INCOMING STREAM...");
            call.answer();
            call.on('stream', (s) => {
                print("DATA RECEIVED! Resolution: " + s.getVideoTracks()[0].getSettings().width + "x" + s.getVideoTracks()[0].getSettings().height);
                video.srcObject = s;
                video.play();
                
                // Force A-Frame to realize the video has started
                setTimeout(() => {
                    screen.setAttribute('material', 'src', '#shared-video');
                    print("Texture Forced.");
                }, 1000);
            });
        });

        async function startSharing() {
            const tid = document.getElementById('target-id').value;
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                peer.call(tid, stream);
                print("Calling " + tid + "...");
            } catch (e) { alert("Check Desktop Mode!"); }
        }

        function fixView() {
            print("Recentering screen...");
            const camRot = camera.getAttribute('rotation');
            // Move the screen directly where you are looking
            anchor.setAttribute('rotation', `0 ${camRot.y} 0`);
            print("Screen moved to face you.");
        }

        function forcePlay() {
            video.muted = false;
            video.play();
            // Force the texture to update manually
            const mesh = screen.getObject3D('mesh');
            if(mesh) mesh.material.map.needsUpdate = true;
            print("Force play/texture update.");
        }

        // Texture Refresh Loop (critical for some Android GPUs)
        setInterval(() => {
            if (video.readyState >= 2) {
                const mesh = screen.getObject3D('mesh');
                if (mesh && mesh.material.map) mesh.material.map.needsUpdate = true;
            }
        }, 100);
    </script>
</body>
</html>
